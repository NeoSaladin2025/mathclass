<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ë ˆì´ì•„ì›ƒ */
        .dashboard {
            display: flex;
            height: 100vh;
        }
        
        /* ì™¼ìª½ ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .sidebar-header h1 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        
        .sidebar-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ì§„í–‰ ìƒí™© */
        .progress-area {
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .progress-area h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .progress-status {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            min-height: 60px;
            display: none;
        }
        
        .progress-status.active {
            display: block;
        }
        
        /* ë©”ë‰´ */
        .menu {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .menu-item {
            padding: 15px 20px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }
        
        .menu-icon {
            font-size: 20px;
        }
        
        /* ë¡œê·¸ì•„ì›ƒ */
        .logout-btn {
            margin: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            flex: 1;
            background: #f5f5f5;
            overflow-y: auto;
            padding: 40px;
        }
        
        .content-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-section h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
            font-size: 15px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        input[type="number"] {
            width: 100px;
        }
        
        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        button.secondary {
            background: #28a745;
        }
        
        button.danger {
            background: #dc3545;
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .list-box {
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
        }
        
        .list-item {
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .list-item:hover {
            background: #f0f0f0;
        }
        
        .list-item.selected {
            background: #e3f2fd;
            border: 2px solid #667eea;
        }
        
        .list-item input[type="radio"],
        .list-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .status-box {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .status-label {
            color: #666;
        }
        
        .status-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .divider {
            border-top: 1px solid #e0e0e0;
            margin: 25px 0;
        }
        
        .problem-count-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .problem-count-row label {
            margin: 0;
            min-width: 100px;
        }
        
        .problem-count-row input {
            width: 100px;
        }
        
        .problem-count-row .max-info {
            font-size: 13px;
            color: #999;
        }
        
        .total-summary {
            background: #667eea;
            color: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .range-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .add-range-btn {
            background: #28a745;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ“ ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ</h1>
                <p><strong id="teacherName"></strong>ë‹˜</p>
            </div>
            
            <!-- ì§„í–‰ ìƒí™© -->
            <div class="progress-area">
                <h3>â³ ì§„í–‰ ìƒí™©</h3>
                <div class="progress-status" id="progressStatus">
                    ëŒ€ê¸° ì¤‘...
                </div>
            </div>
            
            <!-- ë©”ë‰´ -->
            <div class="menu">
                <div class="menu-item active" onclick="showSection('homework')">
                    <span class="menu-icon">ğŸ“š</span>
                    <span>ìˆ™ì œ ì¶œì œ</span>
                </div>
                <div class="menu-item" onclick="showSection('diagnostic')">
                    <span class="menu-icon">ğŸ“Š</span>
                    <span>ì§„ë‹¨í‰ê°€ ì¶œì œ</span>
                </div>
            </div>
            
            <!-- ë¡œê·¸ì•„ì›ƒ -->
            <button class="logout-btn" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <!-- ìˆ™ì œ ì¶œì œ ì„¹ì…˜ -->
            <div class="content-section active" id="homeworkSection">
                <h2>ğŸ“š ìˆ™ì œ ì¶œì œ</h2>
                
                <div id="homeworkMessage"></div>
                
                <form id="homeworkForm">
                    <div class="form-group">
                        <label for="hwGradeSelect">1ë‹¨ê³„: í•™ë…„ ì„ íƒ</label>
                        <select id="hwGradeSelect" required onchange="onGradeChange('homework')">
                            <option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì¤‘1">ì¤‘1</option>
                            <option value="ì¤‘2">ì¤‘2</option>
                            <option value="ì¤‘3">ì¤‘3</option>
                            <option value="ê³ 1">ê³ 1</option>
                            <option value="ê³ 2">ê³ 2</option>
                            <option value="ê³ 3">ê³ 3</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>2ë‹¨ê³„: í•™ìƒ ì„ íƒ</label>
                        <div class="list-box" id="hwStudentList">
                            <p style="color: #999; text-align: center;">í•™ë…„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    
                    <div class="form-group" id="hwBookGroup" style="display: none;">
                        <label>3ë‹¨ê³„: ë¬¸ì œì§‘ ì„ íƒ</label>
                        <div class="list-box" id="hwBookList">
                            <p style="color: #999; text-align: center;">í•™ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    
                    <!-- í•™ìƒ í˜„í™© -->
                    <div id="hwStudentStatus" class="hidden">
                        <div class="status-box">
                            <h3 style="font-size: 18px; margin-bottom: 15px; color: #667eea;">
                                ğŸ‘¤ <span id="hwStudentNameDisplay"></span> - <span id="hwBookNameDisplay"></span>
                            </h3>
                            
                            <strong style="font-size: 15px;">ğŸ”„ ë³µìŠµ ê°€ëŠ¥ (í‹€ë¦° ë¬¸ì œ)</strong>
                            <div class="status-row">
                                <span class="status-label">ì¼ë°˜ìœ í˜•:</span>
                                <span class="status-value" id="hwWrongGeneral">0ê°œ</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">ì„œìˆ í˜•:</span>
                                <span class="status-value" id="hwWrongEssay">0ê°œ</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">1ë“±ê¸‰:</span>
                                <span class="status-value" id="hwWrongGrade1">0ê°œ</span>
                            </div>
                            
                            <div class="divider"></div>
                            
                            <strong style="font-size: 15px;">âœ¨ ì•ˆ í‘¼ ë¬¸ì œ</strong>
                            <div class="status-row">
                                <span class="status-label">ì¼ë°˜ìœ í˜•:</span>
                                <span class="status-value" id="hwUnsolvedGeneral">0ê°œ</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">ì„œìˆ í˜•:</span>
                                <span class="status-value" id="hwUnsolvedEssay">0ê°œ</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">1ë“±ê¸‰:</span>
                                <span class="status-value" id="hwUnsolvedGrade1">0ê°œ</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ìˆ™ì œ êµ¬ì„± -->
                    <div id="hwComposition" class="hidden">
                        <div class="form-group">
                            <label for="hwTotal">ì´ ë¬¸í•­ìˆ˜</label>
                            <input type="number" id="hwTotal" min="1" value="80" onchange="updateHomeworkTotals()">
                        </div>
                        
                        <div class="divider"></div>
                        
                        <h3 style="font-size: 18px; margin-bottom: 15px; color: #667eea;">ğŸ”„ ë³µìŠµìš© ë¬¸ì œ</h3>
                        <div class="problem-count-row">
                            <label>ì¼ë°˜ìœ í˜•:</label>
                            <input type="number" id="hwReviewGeneral" min="0" value="0" onchange="updateHomeworkTotals()">
                            <span class="max-info">ìµœëŒ€ <span id="hwMaxReviewGeneral">0</span>ê°œ</span>
                        </div>
                        <div class="problem-count-row">
                            <label>ì„œìˆ í˜•:</label>
                            <input type="number" id="hwReviewEssay" min="0" value="0" onchange="updateHomeworkTotals()">
                            <span class="max-info">ìµœëŒ€ <span id="hwMaxReviewEssay">0</span>ê°œ</span>
                        </div>
                        <div class="problem-count-row">
                            <label>1ë“±ê¸‰:</label>
                            <input type="number" id="hwReviewGrade1" min="0" value="0" onchange="updateHomeworkTotals()">
                            <span class="max-info">ìµœëŒ€ <span id="hwMaxReviewGrade1">0</span>ê°œ</span>
                        </div>
                        <div style="text-align: right; margin-top: 10px;">
                            <strong style="font-size: 16px;">ì†Œê³„: <span id="hwReviewTotal">0</span>ê°œ</strong>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <h3 style="font-size: 18px; margin-bottom: 15px; color: #667eea;">âœ¨ ìƒˆë¬¸ì œ (ì•ˆ í‘¼ ë¬¸ì œ)</h3>
                        <div class="problem-count-row">
                            <label>ì¼ë°˜ìœ í˜•:</label>
                            <input type="number" id="hwNewGeneral" min="0" value="0" onchange="updateHomeworkTotals()">
                            <span class="max-info">ìµœëŒ€ <span id="hwMaxNewGeneral">0</span>ê°œ</span>
                        </div>
                        <div class="problem-count-row">
                            <label>ì„œìˆ í˜•:</label>
                            <input type="number" id="hwNewEssay" min="0" value="0" onchange="updateHomeworkTotals()">
                            <span class="max-info">ìµœëŒ€ <span id="hwMaxNewEssay">0</span>ê°œ</span>
                        </div>
                        <div class="problem-count-row">
                            <label>1ë“±ê¸‰:</label>
                            <input type="number" id="hwNewGrade1" min="0" value="0" onchange="updateHomeworkTotals()">
                            <span class="max-info">ìµœëŒ€ <span id="hwMaxNewGrade1">0</span>ê°œ</span>
                        </div>
                        <div style="text-align: right; margin-top: 10px;">
                            <strong style="font-size: 16px;">ì†Œê³„: <span id="hwNewTotal">0</span>ê°œ</strong>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <div class="total-summary">
                            ì´í•©: <span id="hwGrandTotal">0</span>ê°œ
                        </div>
                        
                        <button type="submit">ìˆ™ì œ ë¶€ì—¬í•˜ê¸°</button>
                    </div>
                </form>
            </div>
            
            <!-- ì§„ë‹¨í‰ê°€ ì¶œì œ ì„¹ì…˜ -->
            <div class="content-section" id="diagnosticSection">
                <h2>ğŸ“Š ì§„ë‹¨í‰ê°€ ì¶œì œ</h2>
                
                <div id="diagMessage"></div>
                
                <form id="diagForm">
                    <div class="form-group">
                        <label for="diagGradeSelect">1ë‹¨ê³„: í•™ë…„ ì„ íƒ</label>
                        <select id="diagGradeSelect" required onchange="onGradeChange('diag')">
                            <option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì¤‘1">ì¤‘1</option>
                            <option value="ì¤‘2">ì¤‘2</option>
                            <option value="ì¤‘3">ì¤‘3</option>
                            <option value="ê³ 1">ê³ 1</option>
                            <option value="ê³ 2">ê³ 2</option>
                            <option value="ê³ 3">ê³ 3</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>2ë‹¨ê³„: í•™ìƒ ì„ íƒ</label>
                        <div class="list-box" id="diagStudentList">
                            <p style="color: #999; text-align: center;">í•™ë…„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    
                    <div class="form-group" id="diagBookGroup" style="display: none;">
                        <label>3ë‹¨ê³„: ë¬¸ì œì§‘ ì„ íƒ</label>
                        <div class="list-box" id="diagBookList">
                            <p style="color: #999; text-align: center;">í•™ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <h3 style="font-size: 18px; margin-bottom: 15px; color: #667eea;">ğŸ“ ì¶œì œ ë²”ìœ„</h3>
                    <div id="rangeContainer">
                        <div class="range-item">
                            <div class="range-inputs">
                                <label style="margin: 0; min-width: 60px;">êµ¬ê°„ 1:</label>
                                <input type="number" class="range-start" min="1" placeholder="ì‹œì‘" required>
                                <span>~</span>
                                <input type="number" class="range-end" min="1" placeholder="ë" required>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-range-btn" onclick="addRange()">+ êµ¬ê°„ ì¶”ê°€</button>
                    
                    <div class="divider"></div>
                    
                    <h3 style="font-size: 18px; margin-bottom: 15px; color: #667eea;">ğŸ“‹ ë¬¸ì œ êµ¬ì„± (ëœë¤ ì¶œì œ)</h3>
                    <div class="info-box">
                        â„¹ï¸ ì¼ë°˜ìœ í˜•: ê° ê·¸ë£¹ì˜ <strong>ëŒ€í‘œ+í„°í”„</strong> ë¬¸ì œê°€ ìë™ ì¶œì œë©ë‹ˆë‹¤
                    </div>
                    <div class="problem-count-row">
                        <label>ì¼ë°˜ìœ í˜• ê·¸ë£¹:</label>
                        <input type="number" id="diagGroupCount" min="0" value="3" onchange="updateDiagTotal()">
                        <span style="font-size: 13px; color: #999;">ê°œ (ê° ê·¸ë£¹ë‹¹ 2ë¬¸ì œ)</span>
                    </div>
                    <div class="problem-count-row">
                        <label>ì„œìˆ í˜•:</label>
                        <input type="number" id="diagEssay" min="0" value="2" onchange="updateDiagTotal()">
                        <span style="font-size: 13px; color: #999;">ë¬¸ì œ</span>
                    </div>
                    <div class="problem-count-row">
                        <label>1ë“±ê¸‰:</label>
                        <input type="number" id="diagGrade1" min="0" value="2" onchange="updateDiagTotal()">
                        <span style="font-size: 13px; color: #999;">ë¬¸ì œ</span>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="total-summary">
                        ì´ ì¶œì œ: <span id="diagTotal">8</span>ë¬¸ì œ
                        <div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
                            (ì¼ë°˜ 6 + ì„œìˆ  2 + 1ë“±ê¸‰ 2)
                        </div>
                    </div>
                    
                    <button type="submit">ğŸ“„ ì§„ë‹¨í‰ê°€ ì¶œì œ ë° ì›Œë“œ ìƒì„±</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby8MLN2_4ix8I3xDHmnCZzoi-R-rg2rWR5zO_g4ywneigLB2Y1lF-aIiMuve3MUgW8/exec';
        
        let currentTeacher = {
            id: '',
            name: ''
        };
        
        let allStudents = [];
        let callbackCounter = 0;
        
        let hwSelectedStudent = null;
        let hwSelectedBook = null;
        let hwStudentStatus = null;
        
        let diagSelectedStudent = null;
        let diagSelectedBook = null;
        
        // í˜ì´ì§€ ë¡œë“œ
        window.onload = function() {
            const teacherId = sessionStorage.getItem('teacherId');
            const teacherName = sessionStorage.getItem('teacherName');
            
            if (!teacherId || !teacherName) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }
            
            currentTeacher.id = teacherId;
            currentTeacher.name = teacherName;
            document.getElementById('teacherName').textContent = teacherName;
            
            loadStudents();
        };
        
        // ì„¹ì…˜ ì „í™˜
        function showSection(section) {
            // ë©”ë‰´ í™œì„±í™”
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // ì„¹ì…˜ í‘œì‹œ
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            if (section === 'homework') {
                document.getElementById('homeworkSection').classList.add('active');
            } else if (section === 'diagnostic') {
                document.getElementById('diagnosticSection').classList.add('active');
            }
        }
        
        // ì§„í–‰ ìƒí™© í‘œì‹œ
        function showProgress(message) {
            const progressStatus = document.getElementById('progressStatus');
            progressStatus.textContent = message;
            progressStatus.classList.add('active');
        }
        
        function hideProgress() {
            const progressStatus = document.getElementById('progressStatus');
            progressStatus.classList.remove('active');
        }
        
        // JSONP API í˜¸ì¶œ
        function callAPI(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback' + (callbackCounter++);
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                const queryParams = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    ...params
                });
                
                const script = document.createElement('script');
                script.src = `${API_URL}?${queryParams.toString()}`;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('API í˜¸ì¶œ ì‹¤íŒ¨'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // í•™ìƒ ëª©ë¡ ë¡œë“œ
        async function loadStudents() {
            try {
                const data = await callAPI('getStudentsWithGrade');
                allStudents = data.students;
                console.log('í•™ìƒ ëª©ë¡:', allStudents);
            } catch (error) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }
        
        // í•™ë…„ ì„ íƒ
        function onGradeChange(type) {
            const gradeSelect = document.getElementById(type === 'homework' ? 'hwGradeSelect' : 'diagGradeSelect');
            const studentList = document.getElementById(type === 'homework' ? 'hwStudentList' : 'diagStudentList');
            const selectedGrade = gradeSelect.value;
            
            if (type === 'homework') {
                hwSelectedStudent = null;
                hwSelectedBook = null;
                document.getElementById('hwBookGroup').style.display = 'none';
                document.getElementById('hwStudentStatus').classList.add('hidden');
                document.getElementById('hwComposition').classList.add('hidden');
            } else {
                diagSelectedStudent = null;
                diagSelectedBook = null;
                document.getElementById('diagBookGroup').style.display = 'none';
            }
            
            if (!selectedGrade) {
                studentList.innerHTML = '<p style="color: #999; text-align: center;">í•™ë…„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</p>';
                return;
            }
            
            const gradeStudents = allStudents.filter(s => s.grade === selectedGrade);
            
            if (gradeStudents.length === 0) {
                studentList.innerHTML = '<p style="color: #999; text-align: center;">í•´ë‹¹ í•™ë…„ì— í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            studentList.innerHTML = '';
            
            gradeStudents.forEach(student => {
                const div = document.createElement('div');
                div.className = 'list-item';
                
                if (type === 'homework') {
                    div.innerHTML = `
                        <input type="radio" name="hwStudent" id="hw_${student.id}" value="${student.id}" onchange="onStudentSelect('${student.id}')">
                        <label for="hw_${student.id}" style="cursor: pointer; margin: 0;">
                            ${student.id} - ${student.name}
                        </label>
                    `;
                } else {
                    div.innerHTML = `
                        <input type="radio" name="diagStudent" id="diag_${student.id}" value="${student.id}" onchange="onDiagStudentSelect('${student.id}')">
                        <label for="diag_${student.id}" style="cursor: pointer; margin: 0;">
                            ${student.id} - ${student.name}
                        </label>
                    `;
                }
                
                studentList.appendChild(div);
            });
        }
        
        // ìˆ™ì œ: í•™ìƒ ì„ íƒ
        function onStudentSelect(studentId) {
            hwSelectedStudent = studentId;
            hwSelectedBook = null;
            
            const student = allStudents.find(s => s.id === studentId);
            
            if (!student || !student.books || student.books.length === 0) {
                alert('í•´ë‹¹ í•™ìƒì˜ ë¬¸ì œì§‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const bookList = document.getElementById('hwBookList');
            bookList.innerHTML = '';
            
            student.books.forEach(bookName => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <input type="radio" name="hwBook" id="hwbook_${bookName}" value="${bookName}" onchange="onBookSelect('${bookName}')">
                    <label for="hwbook_${bookName}" style="cursor: pointer; margin: 0;">
                        ${bookName}
                    </label>
                `;
                bookList.appendChild(div);
            });
            
            document.getElementById('hwBookGroup').style.display = 'block';
            document.getElementById('hwStudentStatus').classList.add('hidden');
            document.getElementById('hwComposition').classList.add('hidden');
        }
        
        // ìˆ™ì œ: ë¬¸ì œì§‘ ì„ íƒ
        async function onBookSelect(bookName) {
            hwSelectedBook = bookName;
            
            const student = allStudents.find(s => s.id === hwSelectedStudent);
            
            document.getElementById('hwStudentNameDisplay').textContent = student.name;
            document.getElementById('hwBookNameDisplay').textContent = bookName;
            
            showProgress('í•™ìƒ í˜„í™© ì¡°íšŒ ì¤‘...');
            
            try {
                const data = await callAPI('getStudentStatus', {
                    student_id: hwSelectedStudent,
                    book_name: bookName
                });
                
                hideProgress();
                
                hwStudentStatus = data;
                
                document.getElementById('hwWrongGeneral').textContent = data.wrong.ì¼ë°˜ìœ í˜• + 'ê°œ';
                document.getElementById('hwWrongEssay').textContent = data.wrong.ì„œìˆ í˜• + 'ê°œ';
                document.getElementById('hwWrongGrade1').textContent = data.wrong['1ë“±ê¸‰'] + 'ê°œ';
                
                document.getElementById('hwUnsolvedGeneral').textContent = data.unsolved.ì¼ë°˜ìœ í˜• + 'ê°œ';
                document.getElementById('hwUnsolvedEssay').textContent = data.unsolved.ì„œìˆ í˜• + 'ê°œ';
                document.getElementById('hwUnsolvedGrade1').textContent = data.unsolved['1ë“±ê¸‰'] + 'ê°œ';
                
                document.getElementById('hwMaxReviewGeneral').textContent = data.wrong.ì¼ë°˜ìœ í˜•;
                document.getElementById('hwMaxReviewEssay').textContent = data.wrong.ì„œìˆ í˜•;
                document.getElementById('hwMaxReviewGrade1').textContent = data.wrong['1ë“±ê¸‰'];
                
                document.getElementById('hwMaxNewGeneral').textContent = data.unsolved.ì¼ë°˜ìœ í˜•;
                document.getElementById('hwMaxNewEssay').textContent = data.unsolved.ì„œìˆ í˜•;
                document.getElementById('hwMaxNewGrade1').textContent = data.unsolved['1ë“±ê¸‰'];
                
                document.getElementById('hwReviewGeneral').max = data.wrong.ì¼ë°˜ìœ í˜•;
                document.getElementById('hwReviewEssay').max = data.wrong.ì„œìˆ í˜•;
                document.getElementById('hwReviewGrade1').max = data.wrong['1ë“±ê¸‰'];
                
                document.getElementById('hwNewGeneral').max = data.unsolved.ì¼ë°˜ìœ í˜•;
                document.getElementById('hwNewEssay').max = data.unsolved.ì„œìˆ í˜•;
                document.getElementById('hwNewGrade1').max = data.unsolved['1ë“±ê¸‰'];
                
                document.getElementById('hwStudentStatus').classList.remove('hidden');
                document.getElementById('hwComposition').classList.remove('hidden');
                
                updateHomeworkTotals();
            } catch (error) {
                hideProgress();
                showMessage('homeworkMessage', 'í•™ìƒ í˜„í™© ì¡°íšŒ ì‹¤íŒ¨', 'error');
                console.error(error);
            }
        }
        
        // ì§„ë‹¨í‰ê°€: í•™ìƒ ì„ íƒ
        function onDiagStudentSelect(studentId) {
            diagSelectedStudent = studentId;
            diagSelectedBook = null;
            
            const student = allStudents.find(s => s.id === studentId);
            
            if (!student || !student.books || student.books.length === 0) {
                alert('í•´ë‹¹ í•™ìƒì˜ ë¬¸ì œì§‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const bookList = document.getElementById('diagBookList');
            bookList.innerHTML = '';
            
            student.books.forEach(bookName => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <input type="radio" name="diagBook" id="diagbook_${bookName}" value="${bookName}" onchange="onDiagBookSelect('${bookName}')">
                    <label for="diagbook_${bookName}" style="cursor: pointer; margin: 0;">
                        ${bookName}
                    </label>
                `;
                bookList.appendChild(div);
            });
            
            document.getElementById('diagBookGroup').style.display = 'block';
        }
        
        // ì§„ë‹¨í‰ê°€: ë¬¸ì œì§‘ ì„ íƒ
        function onDiagBookSelect(bookName) {
            diagSelectedBook = bookName;
        }
        
        // ìˆ™ì œ í•©ê³„ ì—…ë°ì´íŠ¸
        function updateHomeworkTotals() {
            const reviewGeneral = parseInt(document.getElementById('hwReviewGeneral').value) || 0;
            const reviewEssay = parseInt(document.getElementById('hwReviewEssay').value) || 0;
            const reviewGrade1 = parseInt(document.getElementById('hwReviewGrade1').value) || 0;
            
            const newGeneral = parseInt(document.getElementById('hwNewGeneral').value) || 0;
            const newEssay = parseInt(document.getElementById('hwNewEssay').value) || 0;
            const newGrade1 = parseInt(document.getElementById('hwNewGrade1').value) || 0;
            
            const reviewTotal = reviewGeneral + reviewEssay + reviewGrade1;
            const newTotal = newGeneral + newEssay + newGrade1;
            const grandTotal = reviewTotal + newTotal;
            
            document.getElementById('hwReviewTotal').textContent = reviewTotal;
            document.getElementById('hwNewTotal').textContent = newTotal;
            document.getElementById('hwGrandTotal').textContent = grandTotal;
        }
        
        // ì§„ë‹¨í‰ê°€: êµ¬ê°„ ì¶”ê°€
        let rangeCount = 1;
        function addRange() {
            rangeCount++;
            const container = document.getElementById('rangeContainer');
            const div = document.createElement('div');
            div.className = 'range-item';
            div.innerHTML = `
                <div class="range-inputs">
                    <label style="margin: 0; min-width: 60px;">êµ¬ê°„ ${rangeCount}:</label>
                    <input type="number" class="range-start" min="1" placeholder="ì‹œì‘" required>
                    <span>~</span>
                    <input type="number" class="range-end" min="1" placeholder="ë" required>
                    <button type="button" class="danger" onclick="this.parentElement.parentElement.remove(); updateDiagTotal();">X ì‚­ì œ</button>
                </div>
            `;
            container.appendChild(div);
        }
        
        // ì§„ë‹¨í‰ê°€ ì´ ë¬¸ì œ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateDiagTotal() {
            const groupCount = parseInt(document.getElementById('diagGroupCount').value) || 0;
            const essay = parseInt(document.getElementById('diagEssay').value) || 0;
            const grade1 = parseInt(document.getElementById('diagGrade1').value) || 0;
            
            const total = (groupCount * 2) + essay + grade1;
            document.getElementById('diagTotal').textContent = total;
        }
        
        // ìˆ™ì œ ë¶€ì—¬ ì œì¶œ
        document.getElementById('homeworkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!hwSelectedStudent || !hwSelectedBook) {
                showMessage('homeworkMessage', 'í•™ìƒê³¼ ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            
            const reviewCounts = {
                ì¼ë°˜ìœ í˜•: parseInt(document.getElementById('hwReviewGeneral').value) || 0,
                ì„œìˆ í˜•: parseInt(document.getElementById('hwReviewEssay').value) || 0,
                '1ë“±ê¸‰': parseInt(document.getElementById('hwReviewGrade1').value) || 0
            };
            
            const newCounts = {
                ì¼ë°˜ìœ í˜•: parseInt(document.getElementById('hwNewGeneral').value) || 0,
                ì„œìˆ í˜•: parseInt(document.getElementById('hwNewEssay').value) || 0,
                '1ë“±ê¸‰': parseInt(document.getElementById('hwNewGrade1').value) || 0
            };
            
            showProgress('ìˆ™ì œ ë¶€ì—¬ ì¤‘...');
            
            try {
                const data = await callAPI('assignHomework', {
                    student_id: hwSelectedStudent,
                    book_name: hwSelectedBook,
                    review_counts: JSON.stringify(reviewCounts),
                    new_counts: JSON.stringify(newCounts)
                });
                
                hideProgress();
                
                if (data.success) {
                    showMessage('homeworkMessage', `âœ… ${data.message}`, 'success');
                } else {
                    showMessage('homeworkMessage', data.message, 'error');
                }
            } catch (error) {
                hideProgress();
                showMessage('homeworkMessage', 'ìˆ™ì œ ë¶€ì—¬ ì‹¤íŒ¨', 'error');
                console.error(error);
            }
        });
        
        // ì§„ë‹¨í‰ê°€ ì œì¶œ
        document.getElementById('diagForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!diagSelectedStudent) {
                showMessage('diagMessage', 'í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            
            if (!diagSelectedBook) {
                showMessage('diagMessage', 'ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            
            const ranges = [];
            document.querySelectorAll('.range-item').forEach(item => {
                const start = parseInt(item.querySelector('.range-start').value);
                const end = parseInt(item.querySelector('.range-end').value);
                if (start && end && start <= end) {
                    ranges.push({ start, end });
                }
            });
            
            if (ranges.length === 0) {
                showMessage('diagMessage', 'ì¶œì œ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            const groupCount = parseInt(document.getElementById('diagGroupCount').value) || 0;
            const essayCount = parseInt(document.getElementById('diagEssay').value) || 0;
            const grade1Count = parseInt(document.getElementById('diagGrade1').value) || 0;
            
            if (groupCount === 0 && essayCount === 0 && grade1Count === 0) {
                showMessage('diagMessage', 'ìµœì†Œ 1ë¬¸ì œ ì´ìƒ ì¶œì œí•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            showProgress('ğŸ“‹ ì§„ë‹¨í‰ê°€ ì¶œì œ ì¤‘...');
            showMessage('diagMessage', 'â³ ì§„ë‹¨í‰ê°€ ì¶œì œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...', 'success');
            
            try {
                const data = await callAPI('createDiagnosticTest', {
                    student_id: diagSelectedStudent,
                    book_name: diagSelectedBook,
                    ranges: JSON.stringify(ranges),
                    group_count: groupCount,
                    essay_count: essayCount,
                    grade1_count: grade1Count
                });
                
                hideProgress();
                
                if (data.success) {
                    showMessage('diagMessage', `âœ… ${data.message}`, 'success');
                    
                    // í•™ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                    const studentSelect = document.getElementById('diagStudent');
                    const studentName = studentSelect.options[studentSelect.selectedIndex].text;
                    
                    // ìƒˆ ì°½ì—ì„œ ì¶œë ¥ í™”ë©´ ì—´ê¸°
                    openPrintWindow(studentName, diagSelectedBook, data.problems);
                } else {
                    showMessage('diagMessage', data.message, 'error');
                }
            } catch (error) {
                hideProgress();
                showMessage('diagMessage', 'ì§„ë‹¨í‰ê°€ ì¶œì œ ì‹¤íŒ¨: ' + error.message, 'error');
                console.error(error);
            }
        });
        
        // ì§„ë‹¨í‰ê°€ ì¶œë ¥ ì°½ ì—´ê¸°
        function openPrintWindow(studentName, bookName, problems) {
            const printWindow = window.open('', '_blank', 'width=900,height=800');
            
            const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ì§„ë‹¨í‰ê°€ - ${studentName}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Malgun Gothic', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    /* ì¢Œì¸¡ ìƒë‹¨ í•™ìƒ ì´ë¦„ */
    .student-badge {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      z-index: 1000;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
      margin-top: 60px;
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .info {
      color: #666;
      margin-bottom: 20px;
    }
    
    .print-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: transform 0.2s;
    }
    
    .print-btn:hover {
      transform: translateY(-2px);
    }
    
    .print-btn:active {
      transform: translateY(0);
    }
    
    .problem {
      background: white;
      padding: 30px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .problem h3 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    
    .problem img {
      max-width: 100%;
      display: block;
      margin: 20px auto;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .answer-space {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #667eea;
    }
    
    /* ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .student-badge {
        position: static;
        display: inline-block;
        margin-bottom: 10px;
      }
      
      .header {
        box-shadow: none;
        border-bottom: 2px solid #333;
        margin-top: 0;
      }
      
      .print-btn {
        display: none;
      }
      
      .problem {
        box-shadow: none;
        page-break-after: always;
        page-break-inside: avoid;
      }
      
      .problem:last-child {
        page-break-after: auto;
      }
    }
  </style>
</head>
<body>
  <div class="student-badge">
    ğŸ‘¤ ${studentName}
  </div>
  
  <div class="header">
    <h1>ğŸ“ ì§„ë‹¨í‰ê°€: ${bookName}</h1>
    <p class="info">ì¶œì œì¼: ${new Date().toLocaleDateString('ko-KR')}</p>
    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
  </div>
  
  ${problems.map((problemNum, index) => {
    const paddedNum = problemNum.toString().padStart(4, '0');
    return `
      <div class="problem">
        <h3>ë¬¸ì œ ${index + 1}. (ì›ë³¸ ${problemNum}ë²ˆ)</h3>
        <img src="problems/${bookName}/${paddedNum}.png" alt="ë¬¸ì œ ${problemNum}">
        <div class="answer-space">
          <strong>ë‹µ:</strong> __________________________________________
        </div>
      </div>
    `;
  }).join('')}
  
</body>
</html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, message, type) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                if (type === 'error') {
                    messageDiv.innerHTML = '';
                }
            }, 5000);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ í˜ì´ì§€ - ë¬¸ì œì§‘ ê´€ë¦¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
        }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h2 {
            color: #667eea;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .menu-item {
            padding: 15px 20px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 16px;
        }
        
        .menu-item:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        
        .content-section {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 32px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Malgun Gothic', sans-serif;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ì§„ë‹¨í‰ê°€ ì¶œì œ ìŠ¤íƒ€ì¼ */
        .range-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .range-input input {
            width: 100px;
        }
        
        .add-range-btn {
            width: auto;
            padding: 8px 20px;
            margin-top: 10px;
        }
        
        .range-item {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-range-btn {
            width: auto;
            padding: 5px 15px;
            background: #dc3545;
            font-size: 14px;
        }
        
        .count-input-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .count-input-item {
            text-align: center;
        }
        
        .count-input-item input {
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <h2>ğŸ¯ ì „ì²´ ìƒí™©</h2>
        <button class="menu-item active" onclick="showSection('homework')">ğŸ“š ìˆ™ì œ ì¶œì œ</button>
        <button class="menu-item" onclick="showSection('diagnostic')">ğŸ“Š ì§„ë‹¨í‰ê°€ ì¶œì œ</button>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <!-- ìˆ™ì œ ì¶œì œ ì„¹ì…˜ -->
        <div id="homework-section" class="content-section active">
            <h1>ğŸ“š ìˆ™ì œ ì¶œì œ</h1>
            
            <div id="homework-message"></div>
            
            <div class="form-group">
                <label>í•™ë…„ ì„ íƒ</label>
                <select id="homework-grade" onchange="loadHomeworkStudents()">
                    <option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>í•™ìƒ ì„ íƒ</label>
                <select id="homework-student" onchange="loadHomeworkBooks()">
                    <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ë¬¸ì œì§‘ ì„ íƒ</label>
                <select id="homework-book" onchange="loadStudentStatus()">
                    <option value="">ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div id="student-status" style="display: none;">
                <h2 style="margin-top: 30px; color: #667eea;">í•™ìƒ í˜„í™©</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: #fff3cd; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #856404; margin-bottom: 15px;">ë³µìŠµ ê°€ëŠ¥ (í‹€ë¦° ë¬¸ì œ)</h3>
                        <div id="wrong-status"></div>
                    </div>
                    
                    <div style="background: #d1ecf1; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #0c5460; margin-bottom: 15px;">ì•ˆ í‘¼ ë¬¸ì œ</h3>
                        <div id="unsolved-status"></div>
                    </div>
                </div>
                
                <h2 style="color: #667eea; margin-bottom: 20px;">ìˆ™ì œ êµ¬ì„±</h2>
                
                <div class="info" style="font-size: 12px; margin-bottom: 20px;">
                    ğŸ’¡ ì•Œë¦¼: ê° ê·¸ë£¹ì˜ ëŒ€í‘œ+í„°í”„ ë¬¸ì œë¥¼ ìë™ ì¶œì œí•©ë‹ˆë‹¤
                </div>
                
                <h3 style="margin-bottom: 15px;">ë³µìŠµìš© (í‹€ë¦° ë¬¸ì œ)</h3>
                <div class="count-input-group">
                    <div class="count-input-item">
                        <label>ì¼ë°˜ìœ í˜• ê·¸ë£¹</label>
                        <input type="number" id="review-normal" value="5" min="0">
                        <small style="color: #666;">ê°œ (ê° ê·¸ë£¹ 2ë¬¸ì œ)</small>
                    </div>
                    <div class="count-input-item">
                        <label>ì„œìˆ í˜•</label>
                        <input type="number" id="review-essay" value="0" min="0">
                        <small style="color: #666;">ë¬¸ì œ</small>
                    </div>
                    <div class="count-input-item">
                        <label>1ë“±ê¸‰</label>
                        <input type="number" id="review-grade1" value="0" min="0">
                        <small style="color: #666;">ë¬¸ì œ</small>
                    </div>
                </div>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px;">ìƒˆë¬¸ì œ</h3>
                <div class="count-input-group">
                    <div class="count-input-item">
                        <label>ì¼ë°˜ìœ í˜• ê·¸ë£¹</label>
                        <input type="number" id="new-normal" value="5" min="0">
                        <small style="color: #666;">ê°œ (ê° ê·¸ë£¹ 2ë¬¸ì œ)</small>
                    </div>
                    <div class="count-input-item">
                        <label>ì„œìˆ í˜•</label>
                        <input type="number" id="new-essay" value="0" min="0">
                        <small style="color: #666;">ë¬¸ì œ</small>
                    </div>
                    <div class="count-input-item">
                        <label>1ë“±ê¸‰</label>
                        <input type="number" id="new-grade1" value="0" min="0">
                        <small style="color: #666;">ë¬¸ì œ</small>
                    </div>
                </div>
                
                <button onclick="assignHomework()" style="margin-top: 30px;">
                    ì´ ì¶œì œ: <span id="total-count">10</span>ë¬¸ì œ (ì¼ë°˜ <span id="normal-count">6</span> + ì„œìˆ  <span id="essay-count">2</span> + 1ë“±ê¸‰ <span id="grade1-count">2</span>)
                </button>
            </div>
        </div>

        <!-- ì§„ë‹¨í‰ê°€ ì¶œì œ ì„¹ì…˜ -->
        <div id="diagnostic-section" class="content-section">
            <h1>ğŸ“Š ì§„ë‹¨í‰ê°€ ì¶œì œ</h1>
            
            <div id="diagnostic-message"></div>
            
            <div class="form-group">
                <label>í•™ë…„ ì„ íƒ</label>
                <select id="diagnostic-grade" onchange="loadDiagnosticStudents()">
                    <option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>í•™ìƒ ì„ íƒ</label>
                <select id="diagnostic-student" onchange="loadDiagnosticBooks()">
                    <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ë¬¸ì œì§‘ ì„ íƒ</label>
                <select id="diagnostic-book">
                    <option value="">ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <h2 style="color: #667eea; margin-top: 30px;">ğŸ“ ì¶œì œ ë²”ìœ„</h2>
            
            <div class="info" style="font-size: 12px; margin-bottom: 20px;">
                ğŸ’¡ ì•Œë¦¼: ê° ê·¸ë£¹ì˜ ëŒ€í‘œ+í„°í”„ ë¬¸ì œë¥¼ ìë™ ì¶œì œí•©ë‹ˆë‹¤
            </div>
            
            <div id="ranges-container">
                <div class="range-item">
                    <div class="range-input">
                        <input type="number" class="range-start" placeholder="1" value="1" min="1">
                        <span>~</span>
                        <input type="number" class="range-end" placeholder="100" value="100" min="1">
                    </div>
                    <button class="remove-range-btn" onclick="removeRange(this)" style="display: none;">êµ¬ê°„ ì¶”ê°€</button>
                </div>
            </div>
            
            <button class="add-range-btn" onclick="addRange()">+ êµ¬ê°„ ì¶”ê°€</button>
            
            <h2 style="color: #667eea; margin-top: 30px;">ğŸ“Š ë¬¸ì œ êµ¬ì„± (ëœë¤ ì¶œì œ)</h2>
            
            <div class="count-input-group">
                <div class="count-input-item">
                    <label>ì¼ë°˜ìœ í˜• ê·¸ë£¹</label>
                    <input type="number" id="group-count" value="5" min="0">
                    <small style="color: #666;">ê°œ (ê° ê·¸ë£¹ 2ë¬¸ì œ)</small>
                </div>
                <div class="count-input-item">
                    <label>ì„œìˆ í˜•</label>
                    <input type="number" id="essay-count" value="0" min="0">
                    <small style="color: #666;">ë¬¸ì œ</small>
                </div>
                <div class="count-input-item">
                    <label>1ë“±ê¸‰</label>
                    <input type="number" id="grade1-count" value="0" min="0">
                    <small style="color: #666;">ë¬¸ì œ</small>
                </div>
            </div>
            
            <button onclick="createDiagnosticTest()" style="margin-top: 30px;">
                ì´ ì¶œì œ: <span id="diagnostic-total">10</span>ë¬¸ì œ (ì¼ë°˜ <span id="diagnostic-normal">6</span> + ì„œìˆ  <span id="diagnostic-essay">2</span> + 1ë“±ê¸‰ <span id="diagnostic-grade1">2</span>)
            </button>
        </div>
    </div>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbxczIJ6JGCD3H_CJx02WMXRR_pxJZOT8sjDzY51IaBdF6CNFG9dRAf6T0MQGFN6_7g5/exec';
        
        let currentStudents = [];
        
        // ì„¹ì…˜ ì „í™˜
        function showSection(sectionName) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ëª¨ë“  ë©”ë‰´ ì•„ì´í…œ ë¹„í™œì„±í™”
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // ì„ íƒëœ ë©”ë‰´ ì•„ì´í…œ í™œì„±í™”
            event.target.classList.add('active');
            
            // ì„¹ì…˜ì— ë”°ë¼ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            if (sectionName === 'homework') {
                loadGrades('homework');
            } else if (sectionName === 'diagnostic') {
                loadGrades('diagnostic');
            }
        }
        
        // í•™ë…„ ëª©ë¡ ë¡œë“œ
        function loadGrades(type) {
            const callback = 'callback' + Date.now();
            window[callback] = function(response) {
                if (response.success) {
                    const grades = [...new Set(response.students
                        .map(s => s.grade)
                        .filter(g => g))];
                    
                    grades.sort();
                    
                    const select = document.getElementById(type + '-grade');
                    select.innerHTML = '<option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    grades.forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade;
                        select.appendChild(option);
                    });
                    
                    currentStudents = response.students;
                }
                delete window[callback];
            };
            
            const script = document.createElement('script');
            script.src = scriptUrl + '?action=getStudentsWithGrade&callback=' + callback;
            document.body.appendChild(script);
        }
        
        // ìˆ™ì œ - í•™ìƒ ëª©ë¡ ë¡œë“œ
        function loadHomeworkStudents() {
            const grade = document.getElementById('homework-grade').value;
            const select = document.getElementById('homework-student');
            
            select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
            document.getElementById('homework-book').innerHTML = '<option value="">ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            document.getElementById('student-status').style.display = 'none';
            
            if (!grade) return;
            
            const students = currentStudents.filter(s => s.grade === grade);
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                option.dataset.name = student.name;
                select.appendChild(option);
            });
        }
        
        // ìˆ™ì œ - ë¬¸ì œì§‘ ëª©ë¡ ë¡œë“œ
        function loadHomeworkBooks() {
            const studentId = document.getElementById('homework-student').value;
            const select = document.getElementById('homework-book');
            
            select.innerHTML = '<option value="">ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            document.getElementById('student-status').style.display = 'none';
            
            if (!studentId) return;
            
            const student = currentStudents.find(s => s.id === studentId);
            
            if (student && student.books) {
                student.books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book;
                    option.textContent = book;
                    select.appendChild(option);
                });
            }
        }
        
        // í•™ìƒ í˜„í™© ë¡œë“œ
        function loadStudentStatus() {
            const studentId = document.getElementById('homework-student').value;
            const bookName = document.getElementById('homework-book').value;
            
            if (!studentId || !bookName) {
                document.getElementById('student-status').style.display = 'none';
                return;
            }
            
            const callback = 'callback' + Date.now();
            window[callback] = function(response) {
                if (response.success) {
                    document.getElementById('student-status').style.display = 'block';
                    
                    document.getElementById('wrong-status').innerHTML = `
                        <div style="margin-bottom: 10px;">ì¼ë°˜ìœ í˜•: <strong>${response.wrong.ì¼ë°˜ìœ í˜•}</strong>ë¬¸ì œ</div>
                        <div style="margin-bottom: 10px;">ì„œìˆ í˜•: <strong>${response.wrong.ì„œìˆ í˜•}</strong>ë¬¸ì œ</div>
                        <div>1ë“±ê¸‰: <strong>${response.wrong['1ë“±ê¸‰']}</strong>ë¬¸ì œ</div>
                    `;
                    
                    document.getElementById('unsolved-status').innerHTML = `
                        <div style="margin-bottom: 10px;">ì¼ë°˜ìœ í˜•: <strong>${response.unsolved.ì¼ë°˜ìœ í˜•}</strong>ë¬¸ì œ</div>
                        <div style="margin-bottom: 10px;">ì„œìˆ í˜•: <strong>${response.unsolved.ì„œìˆ í˜•}</strong>ë¬¸ì œ</div>
                        <div>1ë“±ê¸‰: <strong>${response.unsolved['1ë“±ê¸‰']}</strong>ë¬¸ì œ</div>
                    `;
                    
                    updateHomeworkCount();
                }
                delete window[callback];
            };
            
            const params = new URLSearchParams({
                student_id: studentId,
                book_name: bookName
            });
            
            const script = document.createElement('script');
            script.src = scriptUrl + '?action=getStudentStatus&' + params + '&callback=' + callback;
            document.body.appendChild(script);
        }
        
        // ìˆ™ì œ ë¬¸ì œ ìˆ˜ ê³„ì‚°
        function updateHomeworkCount() {
            const reviewNormal = parseInt(document.getElementById('review-normal').value) || 0;
            const reviewEssay = parseInt(document.getElementById('review-essay').value) || 0;
            const reviewGrade1 = parseInt(document.getElementById('review-grade1').value) || 0;
            
            const newNormal = parseInt(document.getElementById('new-normal').value) || 0;
            const newEssay = parseInt(document.getElementById('new-essay').value) || 0;
            const newGrade1 = parseInt(document.getElementById('new-grade1').value) || 0;
            
            const totalNormal = (reviewNormal + newNormal) * 2;
            const totalEssay = reviewEssay + newEssay;
            const totalGrade1 = reviewGrade1 + newGrade1;
            const total = totalNormal + totalEssay + totalGrade1;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('normal-count').textContent = totalNormal;
            document.getElementById('essay-count').textContent = totalEssay;
            document.getElementById('grade1-count').textContent = totalGrade1;
        }
        
        // ì…ë ¥ ê°’ ë³€ê²½ ì‹œ ìë™ ê³„ì‚°
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = ['review-normal', 'review-essay', 'review-grade1', 
                          'new-normal', 'new-essay', 'new-grade1'];
            
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateHomeworkCount);
                }
            });
        });
        
        // ìˆ™ì œ ë¶€ì—¬
        function assignHomework() {
            const studentId = document.getElementById('homework-student').value;
            const bookName = document.getElementById('homework-book').value;
            
            if (!studentId || !bookName) {
                showMessage('homework', 'í•™ìƒê³¼ ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            
            const reviewCounts = {
                ì¼ë°˜ìœ í˜•: parseInt(document.getElementById('review-normal').value) || 0,
                ì„œìˆ í˜•: parseInt(document.getElementById('review-essay').value) || 0,
                '1ë“±ê¸‰': parseInt(document.getElementById('review-grade1').value) || 0
            };
            
            const newCounts = {
                ì¼ë°˜ìœ í˜•: parseInt(document.getElementById('new-normal').value) || 0,
                ì„œìˆ í˜•: parseInt(document.getElementById('new-essay').value) || 0,
                '1ë“±ê¸‰': parseInt(document.getElementById('new-grade1').value) || 0
            };
            
            showMessage('homework', 'ìˆ™ì œ ì¶œì œ ì¤‘... 10~20ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤.', 'info');
            
            const callback = 'callback' + Date.now();
            window[callback] = function(response) {
                if (response.success) {
                    showMessage('homework', response.message + '<br>ë¬¸ì œ ë²ˆí˜¸: ' + response.problems.join(', '), 'success');
                } else {
                    showMessage('homework', response.message, 'error');
                }
                delete window[callback];
            };
            
            const params = new URLSearchParams({
                student_id: studentId,
                book_name: bookName,
                review_counts: JSON.stringify(reviewCounts),
                new_counts: JSON.stringify(newCounts)
            });
            
            const script = document.createElement('script');
            script.src = scriptUrl + '?action=assignHomework&' + params + '&callback=' + callback;
            document.body.appendChild(script);
        }
        
        // ì§„ë‹¨í‰ê°€ - í•™ìƒ ëª©ë¡ ë¡œë“œ
        function loadDiagnosticStudents() {
            const grade = document.getElementById('diagnostic-grade').value;
            const select = document.getElementById('diagnostic-student');
            
            select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
            document.getElementById('diagnostic-book').innerHTML = '<option value="">ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (!grade) return;
            
            const students = currentStudents.filter(s => s.grade === grade);
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                option.dataset.name = student.name;
                select.appendChild(option);
            });
        }
        
        // ì§„ë‹¨í‰ê°€ - ë¬¸ì œì§‘ ëª©ë¡ ë¡œë“œ
        function loadDiagnosticBooks() {
            const studentId = document.getElementById('diagnostic-student').value;
            const select = document.getElementById('diagnostic-book');
            
            select.innerHTML = '<option value="">ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (!studentId) return;
            
            const student = currentStudents.find(s => s.id === studentId);
            
            if (student && student.books) {
                student.books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book;
                    option.textContent = book;
                    select.appendChild(option);
                });
            }
        }
        
        // ë²”ìœ„ ì¶”ê°€
        function addRange() {
            const container = document.getElementById('ranges-container');
            const rangeItem = document.createElement('div');
            rangeItem.className = 'range-item';
            rangeItem.innerHTML = `
                <div class="range-input">
                    <input type="number" class="range-start" placeholder="1" min="1">
                    <span>~</span>
                    <input type="number" class="range-end" placeholder="100" min="1">
                </div>
                <button class="remove-range-btn" onclick="removeRange(this)">ì‚­ì œ</button>
            `;
            container.appendChild(rangeItem);
        }
        
        // ë²”ìœ„ ì‚­ì œ
        function removeRange(button) {
            button.parentElement.remove();
        }
        
        // ì§„ë‹¨í‰ê°€ ë¬¸ì œ ìˆ˜ ê³„ì‚°
        function updateDiagnosticCount() {
            const groupCount = parseInt(document.getElementById('group-count').value) || 0;
            const essayCount = parseInt(document.getElementById('essay-count').value) || 0;
            const grade1Count = parseInt(document.getElementById('grade1-count').value) || 0;
            
            const totalNormal = groupCount * 2;
            const total = totalNormal + essayCount + grade1Count;
            
            document.getElementById('diagnostic-total').textContent = total;
            document.getElementById('diagnostic-normal').textContent = totalNormal;
            document.getElementById('diagnostic-essay').textContent = essayCount;
            document.getElementById('diagnostic-grade1').textContent = grade1Count;
        }
        
        // ì§„ë‹¨í‰ê°€ ì…ë ¥ ê°’ ë³€ê²½ ì‹œ ìë™ ê³„ì‚°
        document.addEventListener('DOMContentLoaded', function() {
            const diagnosticInputs = ['group-count', 'essay-count', 'grade1-count'];
            
            diagnosticInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateDiagnosticCount);
                }
            });
        });
        
        // ì§„ë‹¨í‰ê°€ ì¶œì œ
        function createDiagnosticTest() {
            const studentSelect = document.getElementById('diagnostic-student');
            const studentId = studentSelect.value;
            const studentName = studentSelect.options[studentSelect.selectedIndex]?.dataset.name;
            const bookName = document.getElementById('diagnostic-book').value;
            
            if (!studentId || !bookName) {
                showMessage('diagnostic', 'í•™ìƒê³¼ ë¬¸ì œì§‘ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }
            
            // ë²”ìœ„ ìˆ˜ì§‘
            const ranges = [];
            document.querySelectorAll('.range-item').forEach(item => {
                const start = parseInt(item.querySelector('.range-start').value);
                const end = parseInt(item.querySelector('.range-end').value);
                if (start && end && start <= end) {
                    ranges.push({start: start, end: end});
                }
            });
            
            if (ranges.length === 0) {
                showMessage('diagnostic', 'ì¶œì œ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            const groupCount = parseInt(document.getElementById('group-count').value) || 0;
            const essayCount = parseInt(document.getElementById('essay-count').value) || 0;
            const grade1Count = parseInt(document.getElementById('grade1-count').value) || 0;
            
            if (groupCount === 0 && essayCount === 0 && grade1Count === 0) {
                showMessage('diagnostic', 'ìµœì†Œ 1ë¬¸ì œ ì´ìƒ ì¶œì œí•˜ì„¸ìš”.', 'error');
                return;
            }
            
            showMessage('diagnostic', 'ì§„ë‹¨í‰ê°€ ì¶œì œ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'info');
            
            const callback = 'callback' + Date.now();
            window[callback] = function(response) {
                if (response.success) {
                    showMessage('diagnostic', response.message, 'success');
                    
                    // ìƒˆ ì°½ì—ì„œ ì¶œë ¥ í™”ë©´ ì—´ê¸°
                    openPrintWindow(studentName, bookName, response.problems);
                } else {
                    showMessage('diagnostic', response.message, 'error');
                }
                delete window[callback];
            };
            
            const params = new URLSearchParams({
                student_id: studentId,
                book_name: bookName,
                ranges: JSON.stringify(ranges),
                group_count: groupCount,
                essay_count: essayCount,
                grade1_count: grade1Count
            });
            
            const script = document.createElement('script');
            script.src = scriptUrl + '?action=createDiagnosticTest&' + params + '&callback=' + callback;
            document.body.appendChild(script);
        }
        
        // ì§„ë‹¨í‰ê°€ ì¶œë ¥ ì°½ ì—´ê¸°
        function openPrintWindow(studentName, bookName, problems) {
            const printWindow = window.open('', '_blank', 'width=900,height=800');
            
            const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ì§„ë‹¨í‰ê°€ - ${studentName}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Malgun Gothic', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    /* ì¢Œì¸¡ ìƒë‹¨ í•™ìƒ ì´ë¦„ */
    .student-badge {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      z-index: 1000;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
      margin-top: 60px;
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .info {
      color: #666;
      margin-bottom: 20px;
    }
    
    .print-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: transform 0.2s;
    }
    
    .print-btn:hover {
      transform: translateY(-2px);
    }
    
    .print-btn:active {
      transform: translateY(0);
    }
    
    .problem {
      background: white;
      padding: 30px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .problem h3 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    
    .problem img {
      max-width: 100%;
      display: block;
      margin: 20px auto;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .answer-space {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #667eea;
    }
    
    /* ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .student-badge {
        position: static;
        display: inline-block;
        margin-bottom: 10px;
      }
      
      .header {
        box-shadow: none;
        border-bottom: 2px solid #333;
        margin-top: 0;
      }
      
      .print-btn {
        display: none;
      }
      
      .problem {
        box-shadow: none;
        page-break-after: always;
        page-break-inside: avoid;
      }
      
      .problem:last-child {
        page-break-after: auto;
      }
    }
  </style>
</head>
<body>
  <!-- ì¢Œì¸¡ ìƒë‹¨ í•™ìƒ ì´ë¦„ -->
  <div class="student-badge">
    ğŸ‘¤ ${studentName}
  </div>
  
  <div class="header">
    <h1>ğŸ“ ì§„ë‹¨í‰ê°€: ${bookName}</h1>
    <p class="info">ì¶œì œì¼: ${new Date().toLocaleDateString('ko-KR')}</p>
    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
  </div>
  
  ${problems.map((problemNum, index) => {
    const paddedNum = problemNum.toString().padStart(4, '0');
    return `
      <div class="problem">
        <h3>ë¬¸ì œ ${index + 1}. (ì›ë³¸ ${problemNum}ë²ˆ)</h3>
        <img src="problems/${bookName}/${paddedNum}.png" alt="ë¬¸ì œ ${problemNum}">
        <div class="answer-space">
          <strong>ë‹µ:</strong> __________________________________________
        </div>
      </div>
    `;
  }).join('')}
  
</body>
</html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(section, message, type) {
            const messageDiv = document.getElementById(section + '-message');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
            }
        }
        
        // ì´ˆê¸° ë¡œë“œ
        loadGrades('homework');
    </script>
</body>
</html>
